import requests
import json
from Crypto.Hash import SHA256
from Crypto.PublicKey import ECC
from Crypto.Signature import DSS
from urllib.request import Request, urlopen
from urllib.parse import urljoin
from datetime import datetime, timedelta
import time

own_timeserver = "http://localhost:8000"
end_privatekey = "privatekey"
server = "https://web-one-day-one-letter-lz56g6.wanictf.org/"

def get_privatekey_of_timeserver():
    req = Request(urljoin(own_timeserver, end_privatekey))
    with urlopen(req) as res:
        key_text = res.read().decode('utf-8')
        return ECC.import_key(key_text)


privatekey = get_privatekey_of_timeserver() # Get private key

flag = ""
day = 0
while flag == "" or "?" in flag:

    # Generate time
    current_date = datetime.now()
    future_date = current_date + timedelta(days=day)
    unix_timestamp = int(time.mktime(future_date.timetuple()))
    encoded_timestamp = str(unix_timestamp).encode('utf-8')
    timestamp = encoded_timestamp
    
    #Sign timestamp with known private key
    h = SHA256.new(timestamp)
    signer = DSS.new(privatekey, 'fips-186-3')
    signature = signer.sign(h)

    #Send request to the chal server
    data = {"timestamp": timestamp,
            "signature": signature,
            "timeserver":"boar-definite-imp.ngrok-free.app"}
    
    req = requests.post(server, data=data)
    print(req.text)
    
    # TODO: Get flag letters and add to the flag variable


    # Add one more day
    day = day + 1
    
    

